<%
  create_path =
    new_category_project_issue_task_path(@category, @issue.project, @issue)
%>

<div class="issue-show-page">
  <%= issue_header(@issue) %>

  <div class="issue-columns">
    <div class="issue-column first-column">
      <section class="issue-tasks">
        <h4 class="issue-column-title">Tasks</h4>
        <ul class="issue-tasks">
          <% @issue.tasks.each do |task| %>
            <li class="issue-task" id="issue-task-<%= task.id %>">
              <%= task_type_icon_tag(task.task_type) %>
              <%= link_to task.summary,
                          category_project_task_path(@category, @issue.project, task) %>
            </li>
          <% end %>
          <li class="new-issue-task">
            <%= icon('plus') %>
            <%= link_to 'Add Task', create_path, class: 'create-link' %>
          </li>
        </ul>
      </section>

      <section class="issue-status">
        <h4 class="task-column-title">Status</h4>
        <p class="issue-status">
          <% if @issue.open? %>
            Open
            <%= divider %>
            <%= link_to 'change to closed',
                        close_issue_path(@issue),
                        method: :patch,
                        class: 'secondary-link' %>
          <% else %>
            Closed
            <%= divider %>
            <%= link_to 'change to open',
                        open_issue_path(@issue),
                        method: :patch,
                        class: 'secondary-link' %>
          <% end %>
        </p>
      </div>
    </section>

    <div class="issue-column second-column">
      <div class="issue-comments comments">
        <div class="comment issue-description">
          <header class="issue-user-date">
            <p><span class="issue-user"><%= @issue.user ? @issue.user.name_or_email : User.destroyed_name %></span>:</p>
            <p class="issue-dates"><%= format_date @issue.created_at %></p>
          </header>

          <%= content_tag :main, @issue.description_html.html_safe %>

          <footer>
            <%= link_to 'edit',
                        edit_category_project_issue_path(@category, @issue.project, @issue) %>
          </footer>
        </div>

        <%# TODO: link to new task from comment, auto assign %>
        <%= render partial: 'roller_comments/comment', collection: @comments,
                   locals: { category: @category, project: @issue.project,
                             object: @issue } %>

        <%= render 'roller_comments/form',
                   category: @category, project: @issue.project, object: @issue,
                   comment: @comment, user_options: @comment_user_options %>
      </div>
    </div>
  </div>
</div>
