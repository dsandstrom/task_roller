<%
# TODO: show relavant notifications (category issue/task changed)
projects =
  if category.visible?
    category.projects.all_visible.accessible_by(current_ability)
  else
    category.projects
  end
projects_count = projects.count
issues_count =
  if category.visible?
    category.issues.all_visible.accessible_by(current_ability).count
  else
    category.issues.count
  end
tasks_count =
  if category.visible?
    category.tasks.all_visible.accessible_by(current_ability).count
  else
    category.tasks.count
  end
issue_subscription =
  category.category_issues_subscriptions
          .find_or_initialize_by(user_id: current_user.id)
task_subscription =
  category.category_tasks_subscriptions
          .find_or_initialize_by(user_id: current_user.id)
project_links = projects.map do |project|
  link_to_if can?(:read, project), content_tag(:strong, project.name)
end
%>

<div id="category-<%= category.id %>" class="category">
  <h3 class="category-name">
    <%= link_to_if can?(:read, category),
                   category.name,
                   category_projects_path(category) %>
  </h3>
  <%= category_tags(category) %>

  <p class="category-project-links">
    <%= pluralize(projects_count, 'Project') %><% if project_links.any? %>:
      <%= safe_join(project_links, ', ') %>
    <% end %>
  </p>

  <p class="category-counts">
    <%= link_to_if can?(:read, Issue),
                   pluralize(issues_count, 'Issue'),
                   category_issues_path(category) %>
    <%= divider %>
    <%= link_to_if can?(:read, Task),
                   pluralize(tasks_count, 'Task'),
                   category_tasks_path(category) %>
  </p>

  <p class="category-links">
    <% if can?(:update, category) %>
      <%= link_to 'Edit', edit_category_path(category),
                  class: 'button button-clear' %>
    <% end %>
    <% if can?(:destroy, category) %>
      <%= link_to 'Delete', category_path(category),
                  method: :delete, data: { confirm: 'Are you sure?' },
                  class: 'button button-clear button-warning' %>
    <% end %>
  </p>

  <p class="subscription-links">
    <%= render issue_subscription %>
    <%= render task_subscription %>
  </p>
</div>
