<%
# TODO: show relavant notifications (category issue/task changed)
projects =
  if category.visible?
    category.projects.all_visible.accessible_by(current_ability)
  else
    category.projects
  end
projects_count = projects.count
issues_count =
  if category.visible?
    category.issues.all_visible.accessible_by(current_ability).count
  else
    category.issues.count
  end
tasks_count =
  if category.visible?
    category.tasks.all_visible.accessible_by(current_ability).count
  else
    category.tasks.count
  end
issues_subscription =
  category.category_issues_subscriptions
          .find_or_initialize_by(user_id: current_user.id)
tasks_subscription =
  category.category_tasks_subscriptions
          .find_or_initialize_by(user_id: current_user.id)
project_links = projects.map do |project|
  link_to_if can?(:read, project), content_tag(:strong, project.name), project
end
%>

<div id="category-<%= category.id %>" class="category">
  <h3 class="category-name">
    <%= link_to_if can?(:read, category),
                   category.name, category %>
  </h3>
  <%= category_tags(category) %>

  <div class="category-stats">
    <div class="category-stat-wrapper category-projects-wrapper">
      <p class="category-stat category-projects-count">
        <%= content_tag :span, projects_count, class: 'category-stat-number' %>
        <%= link_to_if can?(:read, Project),
                       'Project'.pluralize(projects_count),
                       category_projects_path(category),
                       class: 'category-stat-name' %>
      </p>

      <% if project_links.any? %>
        <%= content_tag :p, safe_join(project_links, ', '),
                        class: 'category-stat-content category-projects-links' %>
      <% end %>
    </div>

    <div class="category-stat-wrapper">
      <p class="category-stat category-issues-count">
        <%= content_tag :span, issues_count, class: 'category-stat-number' %>
        <%= link_to_if can?(:read, Issue),
                       'Issue'.pluralize(issues_count),
                       category_issues_path(category),
                       class: 'category-stat-name' %>
      </p>

      <% if issues_subscription.persisted? %>
        <% if can?(:destroy, issues_subscription) %>
          <div class="category-stat-content">
            <% url = category_issues_subscription_path(category,
                                                       issues_subscription) %>

            <%= link_to ' ', url,
                        method: :delete,
                        class: 'button button-success button-clear button-unsubscribe' %>
          </div>
        <% end %>
      <% elsif can?(:create, issues_subscription) %>
        <div class="category-stat-content">
          <%= link_to 'auto-subscribe',
                      category_issues_subscriptions_path(category),
                      method: :post, class: 'button button-clear' %>
        </div>
      <% end %>
    </div>


    <div class="category-stat-wrapper">
      <p class="category-stat category-tasks-count">
        <%= content_tag :span, tasks_count, class: 'category-stat-number' %>
        <%= link_to_if can?(:read, Task),
                       'Task'.pluralize(tasks_count),
                       category_tasks_path(category),
                       class: 'category-stat-name' %>
      </p>

      <% if tasks_subscription.persisted? %>
        <% if can?(:destroy, tasks_subscription) %>
          <div class="category-stat-content">
            <% url = category_tasks_subscription_path(category,
                                                       tasks_subscription) %>

            <%= link_to ' ', url,
                        method: :delete,
                        class: 'button button-success button-clear button-unsubscribe' %>
          </div>
        <% end %>
      <% elsif can?(:create, tasks_subscription) %>
        <div class="category-stat-content">
          <%= link_to 'auto-subscribe',
                      category_tasks_subscriptions_path(category),
                      method: :post, class: 'button button-clear' %>
        </div>
      <% end %>
    </div>
  </div>

  <p class="category-buttons">
    <% if can?(:update, category) %>
      <%= link_to 'Edit', edit_category_path(category),
                  class: 'button button-outline' %>
    <% end %>
    <% if can?(:destroy, category) %>
      <%= link_to 'Delete', category_path(category),
                  method: :delete, data: { confirm: 'Are you sure?' },
                  class: 'button button-outline button-warning' %>
    <% end %>
  </p>
</div>
