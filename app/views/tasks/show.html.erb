<%
comments = @task.comments.includes(:user)
comment = @task.comments.build
assignees = @task.assignees.includes(:progressions)
assigned = @task.assigned
# TODO: add re-open, force close to history
# TODO: add page titles for browsers
%>

<div class="task-show-page">
  <%= task_header(@task) %>

  <div class="task-columns">
    <div class="task-column first-column">
      <section class="task-subscription-wrapper">
        <%= render @task_subscription, task: @task %>
      </section>

      <section class="task-status-wrapper">
        <h4 class="task-column-title">Status</h4>

        <p>
          <%= content_tag :strong, @task.status,
                          class: 'task-status' %>
        </p>

        <% if @task.open? && !@task.in_review? %>
          <p>
            <%
              progressions =
                @task.progressions.unfinished
                     .where('progressions.user_id = ?', current_user.id)
            %>
            <% if progressions.any? %>
              <%= render partial: 'shared/progression',
                         collection: progressions,
                         locals: { task: @task } %>
            <% elsif @task.assigned? &&
                     can?(:create, @task.progressions.build(user_id: current_user.id)) %>
              <%= link_to 'start task',
                          task_progressions_path(@task),
                          method: :post, class: 'create-link' %>
            <% end %>

            <% if can?(:create, @task.reviews.build(user_id: current_user.id)) %>
              <%= divider %>
              <%= link_to 'mark complete', task_reviews_path(@task),
                          method: :post %>
            <% end %>
          </p>
        <% end %>

        <% review = @task.current_review %>
        <% if review&.pending? %>
          <p>
            <% if can?(:approve, review) %>
              <%= link_to 'approve',
                          approve_task_review_path(@task, review),
                          method: :patch, class: 'create-link' %>
            <% end %>

            <% if can?(:disapprove, review) %>
              <%= divider %>
              <%= link_to 'disapprove',
                          disapprove_task_review_path(@task, review),
                          method: :patch, class: 'destroy-link' %>
            <% end %>

            <% if can?(:destroy, review) %>
              <% confirm = 'Are you sure you want to cancel the review?' %>
              <%= link_to 'cancel review',
                          task_review_path(@task, review),
                          method: :delete, data: { confirm: confirm },
                          class: 'destroy-link' %>
            <% end %>
          </p>
        <% end %>

        <% if can?(:create, TaskConnection) && @task.open? &&
              !@task.in_review? && @task.duplicatee.blank? %>
          <p>
            <%= link_to 'mark duplicate',
                        new_task_connection_path(@task),
                        class: 'normal-link' %>
          </p>
        <% end %>

        <% if @task.duplicatee.present? %>
          <% duplicatee = @task.duplicatee %>
          <p>
            Duplicate of:
            <%= link_to_if can?(:read, duplicatee),
                           duplicatee.short_summary, task_path(duplicatee) %>
          </p>

          <% if can?(:destroy, TaskConnection) %>
            <%
              confirm = "Are you sure you want to remove the connection to " \
                        "\"#{duplicatee.short_summary}\" and reopen " \
                        "this task?"
            %>
            <p>
              <%= link_to 'Mark not a duplicate and reopen',
                           @task.source_task_connection,
                           method: :delete, class: 'destroy-link',
                           data: { confirm: confirm } %>
            </p>
          <% end %>
        <% end %>

        <% if can?(:close, @task) %>
          <p>
            <% if @task.open? %>
              <%= link_to 'force close',
                          close_task_path(@task),
                          method: :patch, class: 'secondary-link' %>
            <% else %>
              <%= link_to 'reopen',
                          open_task_path(@task),
                          method: :patch, class: 'secondary-link' %>
            <% end %>
          </p>
        <% end %>
      </section>

      <% if @task.open? %>
        <section class="task-assignees-wrapper">
          <h4 class="task-column-title">Assigned</h4>

          <% if assignees.any? %>
            <dl class="task-assignees">
              <% assignees.each do |assignee| %>
                <%= render 'shared/assignee',
                           assignee: assignee, task: @task,
                           current_assignee: assignee == current_user %>
              <% end %>
            </dl>

            <% if can?(:assign, @task) && !@task.in_review? %>
              <p>
                <%= link_to 'reassign',
                            edit_assignment_path(@task),
                            id: 'task_assignment_link',
                            class: 'secondary-link' %>
              </p>
            <% end %>
          <% else %>
            <p>
              no one
              <%# TODO: add form with ajax with first click, then toggle hide class %>
              <% if !@task.in_review? && can?(:assign, @task) %>
                <%= divider %>
                <%= link_to 'assign someone',
                            edit_assignment_path(@task),
                            id: 'task_assignment_link',
                            class: 'secondary-link' %>
              <% end %>
            </p>
          <% end %>

          <% if !@task.in_review? && can?(:assign, @task) %>
            <%= render 'assignments/form', task: @task %>
          <% end %>
        </section>
      <% end %>

      <h4 class="task-column-title">History</h4>
      <section class="task-history-wrapper">
        <% if assigned.any? %>
          <dl class="task-assigned">
              <%= render partial: 'shared/assignee',
                         collection: assigned,
                         locals: { task: @task } %>
          </dl>
        <% end %>

        <% if @task.concluded_reviews.any? %>
          <dl class="task-reviews">
            <%= render @task.concluded_reviews, task: @task %>
          </dl>
        <% end %>
      </section>

      <% if @task.open? %>
        <section class="task-reviewer">
          <h4 class="task-column-title">Reviewer</h4>
          <p>
            <span class="task-user">
              <%= @task.user ? @task.user.name_or_email : User.destroyed_name %>
            </span>

            <% if can?(:update, @task)  %>
              <%= divider %>
              <%= link_to 'change', edit_task_path(@task),
                          class: 'secondary-link' %>
            <% end %>
          </p>
        </section>
      <% end %>

      <section class="task-issue">
        <h4 class="task-column-title">Issue</h4>
        <p>
          <% if @task.issue %>
            <%= render 'shared/issue',
                       issue: @task.issue, task: @task,
                       category: @category, project: @project %>
          <% else %>
            <em>no connection</em>
          <% end %>
        </p>
      </section>

      <% if @task.duplicates.any? %>
        <section class="task-connections">
          <h4 class="task-column-title">Duplicate Tasks</h4>

          <% @task.duplicates.each do |duplicate| %>
            <p>
              <%= link_to_if can?(:read, duplicate),
                             duplicate.id_and_summary, task_path(duplicate) %>
            </p>
          <% end %>
        </section>
      <% end %>
    </div>

    <div class="task-column second-column">
      <div class="task-comments comments">
        <div class="comment task-description">
          <header class="task-user-date">
            <p><span class="task-user"><%= @task.user ? @task.user.name_or_email : User.destroyed_name %></span>:</p>
            <p class="task-dates"><%= formatted_dates @task %></p>
          </header>

          <%= content_tag :main, @task.description_html.html_safe %>

          <% if can?(:update, @task)  %>
            <footer>
              <p><%= link_to 'edit', edit_task_path(@task) %></p>
            </footer>
          <% end %>
        </div>

        <%= render partial: 'shared/comment', collection: comments,
                   locals: { category: @category, project: @task.project,
                             object: @task } %>

        <%= render 'shared/new_comment',
                   category: @category, project: @task.project, object: @task,
                   comment: comment, user_options: @comment_user_options %>
      </div>
    </div>
  </div>
</div>
