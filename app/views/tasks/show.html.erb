<%
comments = @task.comments.includes(:user)
comment = @task.comments.build
assignees = @task.assignees.includes(:progressions)
assigned = @task.assigned
%>

<div class="task-show-page">
  <%= task_header(@task) %>

  <div class="task-columns">
    <div class="task-column first-column">
      <section class="task-status">
        <h4 class="task-column-title">Status</h4>

        <p>
          <%= @task.status %>

          <% if @task.open? %>
            <%# TODO: admin only %>
            <span class="divider">|</span>
            <%= link_to 'close',
                        close_category_task_path(@category, @task),
                        method: :patch, class: 'secondary-link' %>
          <% else %>
            <%# TODO: reviewer+ only %>
            <span class="divider">|</span>
            <%= link_to 'reopen',
                        open_category_task_path(@category, @task),
                        method: :patch, class: 'secondary-link' %>
          <% end %>
        </p>

        <% if @task.open? && @task.ready_for_review? %>
          <%# TODO: reviewer+ or worker & assigned %>
          <p>
            <%= link_to 'mark complete',
                        task_reviews_path(@task, review: { user_id: @task.user_id }),
                        method: :post %>
          </p>
        <% elsif @task.current_review %>
          <%= render @task.current_review, task: @task %>
        <% end %>
      </section>

      <section class="task-assignees">
        <h4 class="task-column-title">Assigned</h4>

        <% if assignees.any? %>
          <ul>
            <%= render partial: 'shared/assignee',
                       collection: assignees,
                       locals: { task: @task } %>
          </ul>
          <%# TODO: show if in_progress?  %>
          <%# but need to finish progressions when reassigning %>
          <% if @task.assigned? %>
            <p>
              <%= link_to 'reassign',
                          edit_category_project_task_path(@category, @project, @task),
                          id: 'task_assignment_link', class: 'secondary-link' %>
            </p>
          <% end %>
        <% else %>
          <p>
            no one
            <span class="divider">|</span>
            <%# TODO: reviewer+ only, otherwise allow self-assigning for worker+ %>
            <%# TODO: add form with ajax with first click, then toggle hide class %>
            <%= link_to 'assign someone',
                        edit_category_project_task_path(@category, @project, @task),
                        id: 'task_assignment_link', class: 'secondary-link' %>
          </p>
        <% end %>

        <%= render 'task_assignments/form', task: @task %>

        <% if assigned.any? %>
          <ul class="task-assignees">
              <%= render partial: 'shared/assigned', collection: assigned,
                         locals: { task: @task } %>
          </ul>
        <% end %>
      </section>

      <section class="task-reviewer">
        <h4 class="task-column-title">Reviewer</h4>
        <p>
          <span class="task-user">
            <%= @task.user ? @task.user.name_or_email : User.destroyed_name %>
          </span>

          <%# TODO: allow reviewers+ to self assign %>
          <span class="divider">|</span>
          <%= link_to 'change',
                      edit_category_project_task_path(@category, @task.project, @task),
                      class: 'secondary-link' %>
        </p>
      </section>

      <section class="task-issue">
        <h4 class="task-column-title">Issue</h4>
        <p>
          <% if @task.issue %>
            <%= issue_type_icon_tag(@task.issue.issue_type) %>
            <%= link_to @task.issue.summary,
                        category_project_issue_path(@category, @task.project, @task.issue) %>
            (<%= @task.issue.user.name_or_email %>)
          <% else %>
            <em>no connection</em>
          <% end %>

          <span class="divider">|</span>
          <%= link_to 'change',
                      edit_category_project_task_path(@category, @task.project, @task),
                      class: 'secondary-link' %>
        </p>
      </section>
    </div>

    <div class="task-column second-column">
      <div class="task-comments comments">
        <div class="comment task-description">
          <header class="task-user-date">
            <p><span class="task-user"><%= @task.user ? @task.user.name_or_email : User.destroyed_name %></span>:</p>
            <p class="task-date"><%= format_date @task.created_at %></p>
          </header>

          <%= content_tag :main, @task.description_html.html_safe %>

          <footer>
            <%= link_to 'edit',
                        edit_category_project_task_path(@category, @task.project, @task) %>
          </footer>
        </div>

        <%= render partial: 'roller_comments/comment', collection: comments,
                   locals: { category: @category, project: @task.project, object: @task } %>

        <%= render 'roller_comments/form',
                   category: @category, project: @task.project, object: @task,
                   comment: comment, user_options: @comment_user_options %>
      </div>
    </div>
  </div>
</div>
